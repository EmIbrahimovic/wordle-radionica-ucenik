<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- TEACHING MOMENT: We use double curly braces to insert the 'title' variable from app.py -->
    <title>{{ title }}</title>
    <!-- url_for('static', ...) tells Flask to look in the 'static' folder for our CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
</head>
<body>

    <header>
        <h1>Word<span class="highlight">4</span></h1>
    </header>

    <div id="board"></div>

    <!-- This element is for game-over messages -->
    <div id="message">
        <h2 id="status-text"></h2>
        <button onclick="resetGame()" class="reset-btn">Play Again</button>
    </div>

    <!-- TEACHING MOMENT: A separate small div for quick alerts (like "Not in word list") -->
    <div id="toast"></div>

    <div class="keyboard">
        <div class="kb-row" id="kb-row-1"></div>
        <div class="kb-row" id="kb-row-2"></div>
        <div class="kb-row" id="kb-row-3"></div>
    </div>

    <script>
        const ROWS = 6;
        const COLS = 4;
        let currentRow = 0;
        let currentGuess = "";
        let isGameOver = false;

        // Build the game board rows and tiles
        const board = document.getElementById('board');
        for (let i = 0; i < ROWS; i++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = "row";
            rowDiv.id = `row-${i}`;
            for (let j = 0; j < COLS; j++) {
                const tile = document.createElement('div');
                tile.className = "tile";
                tile.id = `tile-${i}-${j}`;
                rowDiv.appendChild(tile);
            }
            board.appendChild(rowDiv);
        }

        // Virtual keyboard layout
        const kbLayout = ["QWERTYUIOP", "ASDFGHJKL", ["ENTER", "Z", "X", "C", "V", "B", "N", "M", "DEL"]];
        kbLayout.forEach((row, idx) => {
            const container = document.getElementById(`kb-row-${idx + 1}`);
            const keys = Array.isArray(row) ? row : row.split('');
            keys.forEach(key => {
                const btn = document.createElement('button');
                btn.textContent = key === "DEL" ? "â†" : key;
                btn.className = "key";
                if (key.length > 1) btn.classList.add('key-large');
                btn.onclick = () => handleInput(key);
                container.appendChild(btn);
            });
        });

        function handleInput(key) {
            if (isGameOver) return;
            if (key === "ENTER" || key === "Enter") {
                if (currentGuess.length === COLS) submitGuess();
            } else if (key === "DEL" || key === "Backspace") {
                currentGuess = currentGuess.slice(0, -1);
                updateDisplay();
            } else if (/^[a-zA-Z]$/.test(key) && currentGuess.length < COLS) {
                currentGuess += key.toUpperCase();
                updateDisplay();
            }
        }

        function updateDisplay() {
            for (let j = 0; j < COLS; j++) {
                const tile = document.getElementById(`tile-${currentRow}-${j}`);
                tile.textContent = currentGuess[j] || "";
            }
        }

        async function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('visible');
            
            // Shake the current row for emphasis
            const row = document.getElementById(`row-${currentRow}`);
            row.classList.add('shake');
            
            setTimeout(() => {
                toast.classList.remove('visible');
                row.classList.remove('shake');
            }, 1500);
        }

        async function submitGuess() {
            const response = await fetch('/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ guess: currentGuess })
            });

            // TEACHING MOMENT: If the server returns an error (like 400), we handle it here.
            if (!response.ok) {
                const errorData = await response.json();
                showToast(errorData.error || "Invalid Word");
                return;
            }

            const data = await response.json();

            // Color the tiles based on results
            data.results.forEach((res, j) => {
                const tile = document.getElementById(`tile-${currentRow}-${j}`);
                tile.classList.add(`tile-${res.status}`);
            });

            if (data.won) {
                endGame(`Genius! The word was ${data.target} ðŸŽ‰`);
            } else if (currentRow === ROWS - 1) {
                endGame(`Nice try! The word was ${data.target}.`);
            } else {
                currentRow++;
                currentGuess = "";
            }
        }

        function endGame(msg) {
            isGameOver = true;
            document.getElementById('status-text').textContent = msg;
            document.getElementById('message').classList.add('visible');
        }

        async function resetGame() {
            await fetch('/reset', { method: 'POST' });
            window.location.reload();
        }

        window.addEventListener('keydown', (e) => handleInput(e.key));
    </script>
</body>
</html>
