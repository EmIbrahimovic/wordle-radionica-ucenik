<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ naslov }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
</head>
<body>

    <header>
        <h1>RijeÄ<span class="istaknuto">4</span></h1>
    </header>

    <div id="tabla"></div>

    <div id="poruka">
        <h2 id="status-tekst"></h2>
        <button onclick="ponovoPokreniIgru()" class="restart-btn">Igraj ponovo</button>
    </div>

    <div id="obavjestenje"></div>

    <div class="tastatura">
        <div class="tast-red" id="tast-red-1"></div>
        <div class="tast-red" id="tast-red-2"></div>
        <div class="tast-red" id="tast-red-3"></div>
    </div>

    <script>
        const REDOVI = 6;
        const KOLONE = 4;
        let trenutniRed = 0;
        let trenutniPogodak = "";
        let igraJeGotova = false;

        // Inicijalizacija table
        const tabla = document.getElementById('tabla');
        for (let i = 0; i < REDOVI; i++) {
            const redDiv = document.createElement('div');
            redDiv.className = "red";
            redDiv.id = `red-${i}`;
            for (let j = 0; j < KOLONE; j++) {
                const polje = document.createElement('div');
                polje.className = "polje";
                polje.id = `polje-${i}-${j}`;
                redDiv.appendChild(polje);
            }
            tabla.appendChild(redDiv);
        }

        /**
         * TRENUTAK ZA UÄŒENJE: Bosanska tastatura koristi QWERTZ raspored 
         * i sadrÅ¾i dodatna slova Å , Ä, ÄŒ, Ä†, Å½.
         */
        const rasporedTastature = [
            "QWERTZUIOPÅ Ä",
            "ASDFGHJKLÄŒÄ†Å½",
            ["ENTER", "Y", "X", "C", "V", "B", "N", "M", "DEL"]
        ];

        rasporedTastature.forEach((red, indeks) => {
            const kontejner = document.getElementById(`tast-red-${indeks + 1}`);
            const tasteri = Array.isArray(red) ? red : red.split('');
            tasteri.forEach(taster => {
                const dugme = document.createElement('button');
                dugme.textContent = taster === "DEL" ? "â†" : taster;
                dugme.className = "taster";
                if (taster.length > 1) dugme.classList.add('taster-veliki');
                dugme.onclick = () => obradiUnos(taster);
                kontejner.appendChild(dugme);
            });
        });

        function obradiUnos(taster) {
            if (igraJeGotova) return;
            if (taster === "ENTER" || taster === "Enter") {
                if (trenutniPogodak.length === KOLONE) posaljiPogodak();
            } else if (taster === "DEL" || taster === "Backspace") {
                trenutniPogodak = trenutniPogodak.slice(0, -1);
                osvjeziPrikaz();
            } else if (/^[a-zA-ZÄÄ‡Å¾Å¡Ä‘ÄŒÄ†Å½Å Ä]$/.test(taster) && trenutniPogodak.length < KOLONE) {
                // TRENUTAK ZA UÄŒENJE: Regex sada dopuÅ¡ta i naÅ¡a slova sa kvaÄicama.
                trenutniPogodak += taster.toUpperCase();
                osvjeziPrikaz();
            }
        }

        function osvjeziPrikaz() {
            for (let j = 0; j < KOLONE; j++) {
                const polje = document.getElementById(`polje-${trenutniRed}-${j}`);
                polje.textContent = trenutniPogodak[j] || "";
            }
        }

        async function prikaziObavjestenje(tekst) {
            const obavjestenje = document.getElementById('obavjestenje');
            obavjestenje.textContent = tekst;
            obavjestenje.classList.add('vidljivo');
            const red = document.getElementById(`red-${trenutniRed}`);
            red.classList.add('tresi');
            setTimeout(() => {
                obavjestenje.classList.remove('vidljivo');
                red.classList.remove('tresi');
            }, 1500);
        }

        async function posaljiPogodak() {
            const odgovor = await fetch('/provjeri', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pogodak: trenutniPogodak })
            });

            if (!odgovor.ok) {
                const greskaPodaci = await odgovor.json();
                prikaziObavjestenje(greskaPodaci.greska || "Neispravna rijeÄ");
                return;
            }

            const podaci = await odgovor.json();

            podaci.rezultati.forEach((rez, j) => {
                const polje = document.getElementById(`polje-${trenutniRed}-${j}`);
                if (rez.status === 'tacno') polje.classList.add('polje-tacno');
                else if (rez.status === 'prisutno') polje.classList.add('polje-prisutno');
                else polje.classList.add('polje-odsutno');
            });

            if (podaci.pobjeda) {
                zavrsiIgru(`Genijalno! RijeÄ je bila ${podaci.ciljna} ğŸ‰`);
            } else if (trenutniRed === REDOVI - 1) {
                zavrsiIgru(`Dobar pokuÅ¡aj! RijeÄ je bila ${podaci.ciljna}.`);
            } else {
                trenutniRed++;
                trenutniPogodak = "";
            }
        }

        function zavrsiIgru(tekst) {
            igraJeGotova = true;
            document.getElementById('status-tekst').textContent = tekst;
            document.getElementById('poruka').classList.add('vidljivo');
        }

        async function ponovoPokreniIgru() {
            await fetch('/restart', { method: 'POST' });
            window.location.reload();
        }

        window.addEventListener('keydown', (e) => obradiUnos(e.key));
    </script>
</body>
</html>